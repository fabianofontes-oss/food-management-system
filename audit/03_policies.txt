ETAPA 3 - Policies de RLS
Data: 2024-12-19
Query: SELECT schemaname, tablename, policyname, cmd, permissive, roles, qual, with_check FROM pg_policies WHERE schemaname = 'public'

========================================
RESULTADO DA QUERY 3.2
========================================

schemaname | tablename              | policyname                  | cmd    | permissive | roles                  | qual                                                                                                                                                                                                                                      | with_check
-----------|------------------------|-----------------------------| -------|------------|------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|------------
public     | categories             | categories_policy           | ALL    | PERMISSIVE | {authenticated}        | (EXISTS ( SELECT 1 FROM stores WHERE ((stores.id = categories.store_id) AND (EXISTS ( SELECT 1 FROM store_users WHERE ((store_users.store_id = stores.id) AND (store_users.user_id = auth.uid())))))))                                  |
public     | customers              | customers_policy            | ALL    | PERMISSIVE | {authenticated}        | (EXISTS ( SELECT 1 FROM stores WHERE ((stores.id = customers.store_id) AND (EXISTS ( SELECT 1 FROM store_users WHERE ((store_users.store_id = stores.id) AND (store_users.user_id = auth.uid())))))))                                   |
public     | draft_stores           | draft_stores_select         | SELECT | PERMISSIVE | {anon,authenticated}   | true                                                                                                                                                                                                                                      |
public     | draft_stores           | draft_stores_insert         | INSERT | PERMISSIVE | {anon,authenticated}   | true                                                                                                                                                                                                                                      | (expires_at > now())
public     | draft_stores           | draft_stores_update         | UPDATE | PERMISSIVE | {anon,authenticated}   | ((token IS NOT NULL) AND (expires_at > now()))                                                                                                                                                                                            |
public     | invoices               | invoices_policy             | ALL    | PERMISSIVE | {authenticated}        | (tenant_id IN ( SELECT tenants.id FROM tenants WHERE (tenants.owner_id = auth.uid())))                                                                                                                                                   |
public     | order_items            | order_items_policy          | ALL    | PERMISSIVE | {authenticated}        | (EXISTS ( SELECT 1 FROM (orders JOIN stores ON ((stores.id = orders.store_id))) WHERE ((orders.id = order_items.order_id) AND (EXISTS ( SELECT 1 FROM store_users WHERE ((store_users.store_id = stores.id) AND (store_users.user_id = auth.uid())))))))  |
public     | orders                 | orders_policy               | ALL    | PERMISSIVE | {authenticated}        | (EXISTS ( SELECT 1 FROM stores WHERE ((stores.id = orders.store_id) AND (EXISTS ( SELECT 1 FROM store_users WHERE ((store_users.store_id = stores.id) AND (store_users.user_id = auth.uid())))))))                                      |
public     | payment_history        | payment_history_policy      | ALL    | PERMISSIVE | {authenticated}        | (tenant_id IN ( SELECT tenants.id FROM tenants WHERE (tenants.owner_id = auth.uid())))                                                                                                                                                   |
public     | plans                  | plans_select                | SELECT | PERMISSIVE | {authenticated,anon}   | true                                                                                                                                                                                                                                      |
public     | products               | products_policy             | ALL    | PERMISSIVE | {authenticated}        | (EXISTS ( SELECT 1 FROM stores WHERE ((stores.id = products.store_id) AND (EXISTS ( SELECT 1 FROM store_users WHERE ((store_users.store_id = stores.id) AND (store_users.user_id = auth.uid())))))))                                    |
public     | slug_reservations      | slug_reservations_policy    | ALL    | PERMISSIVE | {anon,authenticated}   | true                                                                                                                                                                                                                                      |
public     | store_users            | store_users_policy          | ALL    | PERMISSIVE | {authenticated}        | (EXISTS ( SELECT 1 FROM stores WHERE ((stores.id = store_users.store_id) AND (EXISTS ( SELECT 1 FROM store_users su WHERE ((su.store_id = stores.id) AND (su.user_id = auth.uid())))))))                                                |
public     | stores                 | stores_policy               | ALL    | PERMISSIVE | {authenticated}        | (EXISTS ( SELECT 1 FROM store_users WHERE ((store_users.store_id = stores.id) AND (store_users.user_id = auth.uid()))))                                                                                                                  |
public     | tenant_subscriptions   | tenant_subscriptions_policy | ALL    | PERMISSIVE | {authenticated}        | (tenant_id IN ( SELECT tenants.id FROM tenants WHERE (tenants.owner_id = auth.uid())))                                                                                                                                                   |
public     | tenants                | tenants_policy              | ALL    | PERMISSIVE | {authenticated}        | ((owner_id = auth.uid()) OR (id IN ( SELECT stores.tenant_id FROM (stores JOIN store_users ON ((store_users.store_id = stores.id))) WHERE (store_users.user_id = auth.uid()))))                                                         |
public     | users                  | users_policy                | ALL    | PERMISSIVE | {authenticated}        | (id = auth.uid())                                                                                                                                                                                                                         |

========================================
AN√ÅLISE DE POLICIES
========================================

Total de policies: 16

üî¥ CR√çTICO - Policies com qual = true (acesso irrestrito):
1. draft_stores.draft_stores_select - roles: {anon,authenticated} - SELECT com qual=true
2. draft_stores.draft_stores_insert - roles: {anon,authenticated} - INSERT com qual=true
3. plans.plans_select - roles: {authenticated,anon} - SELECT com qual=true
4. slug_reservations.slug_reservations_policy - roles: {anon,authenticated} - ALL com qual=true

üî¥ CR√çTICO - Policies com role 'anon' em tabelas sens√≠veis:
Nenhuma (anon apenas em draft_stores, plans, slug_reservations - onboarding)

üü° ALTO - Policies com cmd=ALL (muito permissivas):
1. categories_policy - ALL mas com filtro adequado por store_users
2. customers_policy - ALL mas com filtro adequado por store_users
3. invoices_policy - ALL mas com filtro adequado por tenant owner
4. order_items_policy - ALL mas com filtro adequado por store_users
5. orders_policy - ALL mas com filtro adequado por store_users
6. payment_history_policy - ALL mas com filtro adequado por tenant owner
7. products_policy - ALL mas com filtro adequado por store_users
8. store_users_policy - ALL mas com filtro adequado por store_users
9. stores_policy - ALL mas com filtro adequado por store_users
10. tenant_subscriptions_policy - ALL mas com filtro adequado por tenant owner
11. tenants_policy - ALL mas com filtro adequado por owner_id ou store_users
12. users_policy - ALL mas com filtro adequado por auth.uid()
13. slug_reservations_policy - ALL com qual=true (CR√çTICO)

‚úÖ OK - Policies com filtros adequados:
- Todas as policies de tabelas core (tenants, stores, orders, etc.) filtram corretamente por auth.uid() + store_users ou tenant owner
